
# Развёртывание PostgreSQL на серверах Debian и AlmaLinux

Этот проект предоставляет консольное приложение для автоматизированной установки и настройки PostgreSQL на удаленных серверах (Debian или AlmaLinux) с использованием Ansible и Python. Приложение выбирает наименее загруженный сервер, устанавливает PostgreSQL, настраивает его для внешних подключений и ограничивает доступ пользователя `student` только с IP второго сервера.

---

## Предусловия

Для успешного использования приложения убедитесь, что выполнены следующие условия:

- На обоих серверах установлен `sshd` для SSH-доступа и python3 для работы ansible.
- Ваш публичный SSH-ключ импортирован пользователю `root` на серверах.
- На вашей машине установлены `Python3` и `ansible 2.9.27`.

**Тестирование**:
- Проверено на двух виртуальных машинах: Debian 11 (с графикой и Python 3.9.2) и AlmaLinux 8 (серверная конфигурация и Python 3.6.8).
- Скрипты запускались с машины на Ubuntu 22.04.4.

---

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/jarmenyu/PGStart.git
   cd PGStart
   ```

2. **Установите зависимости**:
   ```bash
   pip install paramiko jinja2 ansible==2.9.27

   ```

---

## Использование

Приложение принимает один аргумент — строку с IP-адресами серверов, разделенными запятой.

### Пример запуска
```bash
python pgstart.py "ip_сервера_1,ip_сервера_2"
```

Например:
```bash
python pgstart.py "192.168.0.18,192.168.0.19"
```

### Пример вывода
```
Запуск установки
Нагрузка сервера 192.168.0.18: 0.05
Нагрузка сервера 192.168.0.19: 0.15
Целевой сервер: 192.168.0.18
Инвентарь для Ansible сгенерирован
...
Ansible playbook выполнен успешно
```

---

## Файлы проекта

- **`pgstart.py`**: Основной скрипт, который оценивает нагрузку серверов и запускает Ansible.
- **`playbook.yml`**: Ansible playbook для установки и настройки PostgreSQL.
- **`inventory.yml.j2`**: Шаблон для генерации файла инвентаря Ansible.

---

## Что делает скрипт (`pgstart.py`)

Скрипт `pgstart.py` выполняет следующие шаги:

1. Принимает строку с IP-адресами двух серверов (разделенных запятой).
2. Подключается к серверам по SSH и оценивает их нагрузку с помощью команды `uptime`.
3. Выбирает сервер с меньшей нагрузкой как целевой (`primary`), второй становится `secondary`.
4. Генерирует Ansible-инвентарь (`inventory.yml`) с использованием шаблона Jinja2.
5. Запускает Ansible playbook (`playbook.yml`) для установки и настройки PostgreSQL.

---

## Что делает шаблон (`inventory.yml.j2`)

Шаблон `inventory.yml.j2` используется для генерации файла инвентаря Ansible (`inventory.yml`) и определяет:

1. Два хоста:
   - `primary`: Целевой сервер с IP-адресом `{{ primary_ip }}` (передается из скрипта).
   - `secondary`: Второй сервер с IP-адресом `{{ secondary_ip }}` (передается из скрипта).
2. Глобальные переменные:
   - `ansible_user: root` — пользователь для SSH-подключения.
   - `ansible_ssh_private_key_file: /home/arslan/.ssh/id_rsa` — путь к закрытому SSH-ключу.
---

## Что делает плейбук (`playbook.yml`)

Ansible playbook `playbook.yml` выполняет следующие шаги на целевом сервере (`primary`):

1. Определяет тип операционной системы (Debian или AlmaLinux) для применения правильного метода установки.
2. Устанавливает PostgreSQL 15 с учетом особенностей ОС:
   - Для Debian: Добавляет официальный репозиторий PostgreSQL, устанавливает пакеты postgresql-15 и postgresql-client-15
   - Для AlmaLinux: импортирует GPG-ключ PostgreSQL, Устанавливает RPM-репозиторий, отключает встроенный модуль PostgreSQL, устанавливает пакеты postgresql15-server и postgresql15-contrib
3. Настраивает PostgreSQL для внешних соединений:
   - Устанавливает `listen_addresses = '*'` в `postgresql.conf`.
   - Настраивает аутентификацию через md5 в pg_hba.conf.
4. Создает базу данных `student_db` и пользователя `student` (пароль: `1290`).
5. Ограничивает доступ пользователя `student` к базе `student_db` только с IP второго сервера (`secondary_ip`).
6. Проверяет работу PostgreSQL, выполняя запрос `SELECT 1`.

---

## Вопросы по ТЗ и принятые решения

### Нужно ли включать установку Python в Ansible-плейбук или устанавливать его вручную до запуска?
- Принятый подход: предварительная установка Python на удаленные сервера
